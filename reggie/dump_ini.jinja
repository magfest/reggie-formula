{# Jinja2 macro which converts Python data structure to ConfigObj INI format #}

{%- macro encode_ini_value(value) -%}
  {%- if value is string -%}
    {%- if '\n' in value -%}
      {{ "'''" ~ value ~ "'''" }}
    {%- else -%}
      {%- set quote = "'" if '"' in value else '"' -%}
      {{ quote ~ value ~ quote }}
    {%- endif -%}
  {%- elif value is number -%}
    {{ value }}
  {%- elif value is not none -%}
    {%- if value|length == 1 -%}
      {{ encode_ini_value(value[0]) ~ ',' }}
    {%- elif value|length > 1 -%}
      {%- set comma = joiner(',') -%}
      {%- for v in value -%}{{ comma() }}{{ encode_ini_value(v) }}{%- endfor -%}
    {%- else -%}
      {{ ',' }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro -%}

{%- macro encode_ini(item, depth=1) -%}
  {#- First process settings at the current level -#}
  {%- for property, value in item.items() -%}
    {%- if value is not mapping -%}
{{ property ~ ' = ' ~ encode_ini_value(value) ~ '\n' }}
    {%- endif -%}
  {%- endfor -%}

  {#- Then recurse into each section -#}
  {%- for section, options in item.items() -%}
    {%- if options is mapping %}
{{ ('[' * depth)  ~ section ~ (']' * depth) }}
{{ encode_ini(options, depth + 1) }}
    {%- endif -%}
  {%- endfor -%}
{%- endmacro -%}


{%- macro dump_ini(data) -%}
# =============================================
# THIS FILE IS MANAGED BY SALT.
# Do not edit this file manually.
# Any changes will be automatically reverted.
# =============================================

{{ encode_ini(data) }}
{%- endmacro -%}
